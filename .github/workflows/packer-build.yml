name: Packer Build Image
on:
  push:
    branches:
      - "*"
  # pull_request:
  #   types:
  #     - closed
  #   branches:
  #     - main

env:
  DB_USER: ${{ vars.DB_USER }}
  DB_PWD: ${{ secrets.DB_PWD }}
  DB_NAME: ${{ vars.DB_NAME }}
  DB_PORT: ${{ vars.DB_PORT }}

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  build-image:
    # if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Configure GCP
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.DEV_GCP_SERVICE_IAM }}"
      - name: Set up Cloud SDK
        uses: "google-github-actions/setup-gcloud@v2"
      - name: Setup Packer
        uses: hashicorp/setup-packer@main
      - name: Zip repository
        run: |
          zip -r webapp.zip .
          mv webapp.zip packer-setup/builds
      - name: Run `packer init`
        run: |
          cd packer-setup/builds
          packer init build.pkr.hcl
      - name: Build packer Image
        run: |
          cd packer-setup/builds
          packer build -var-file="variables.pkrvars.hcl" build.pkr.hcl
